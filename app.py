# app.py
from flask import Flask, render_template, request, redirect, url_for, flash, session
import os
import json
from linkedin_agent import run_automation
from dotenv import load_dotenv
import uuid

# Load environment variables
load_dotenv()

app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET_KEY", "default-secret-key")

# Ensure upload directories exist
UPLOAD_FOLDER = os.path.join('static', 'uploads')
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs('logs/linkedin_automation', exist_ok=True)

app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        # Get the prompt from the form
        prompt = request.form.get('prompt')
        
        if not prompt:
            flash('Please enter a prompt', 'error')
            return redirect(url_for('index'))
            
        # Handle image upload
        uploaded_image = None
        if 'linkedin_image' in request.files:
            image_file = request.files['linkedin_image']
            if image_file.filename != '':
                # Generate a unique filename to prevent overwriting
                file_ext = os.path.splitext(image_file.filename)[1]
                unique_filename = f"{uuid.uuid4().hex}{file_ext}"
                image_path = os.path.join(app.config['UPLOAD_FOLDER'], unique_filename)
                image_file.save(image_path)
                uploaded_image = image_path
                
        try:
            # Run the automation with the image if available
            result = run_automation(prompt, uploaded_image)
            
            # Check if the automation was actually successful
            if result['success']:
                flash('Automation completed successfully!', 'success')
            else:
                error_message = "Automation did not complete successfully."
                if result['errors'] and len(result['errors']) > 0:
                    error_message = f"Error during automation: {result['errors'][0]}"
                flash(error_message, 'error')
            
            return redirect(url_for('index'))
        except Exception as e:
            flash(f'Error running automation: {str(e)}', 'error')
            return redirect(url_for('index'))
    
    # Default sample prompts
    sample_prompts = [
        "Go to https://www.linkedin.com/feed/ and comment on posts after reading them, and insert a comment based on their post. For more posts keep scrolling down find and comment on 4 posts. My account email: contact@chebonkelvin.com password: @?Kelvin11468 to understand linkedin user interface on feeds there are three columns, the center one holds inputs at the top to add posts and feeds start from Sort by: Top filter. Posts have white background, there are several post variations. Before I give you variations of posts, posts generally structure is as follows at the top we have elements inline: [image]-[name/companyname]-[message eg 'commented on this']- [3 dots]-[X sign/icon for canceling] next is the profile details person or company posting the post, element are inline[image]-[from top down we have name eg 'Minica Engel +3rd', profile description eg 'Co-founder and managing Partner' time posted eg'1d, 1h' and a globe icon next to it ]-[plus icon and follow text] next post section is post content and from top down here in content we usually have a paragraph maximum 3lines, if a post has more than 3 lines there is a more text like this'...more' this is clickable to reveal more post content for reading, after the paragraph we might have media that is image or video or if someone posted a link we will have link meta descriptions image, title, player. Next post section is elements in line [ icons that represent reactions: likes, love and bulb icon]- [number of comments] final section is of elements inline[like icon with like text not clickable but on hover reaction icons appear you pick like, love or bulb]-[comment icon with comment text onclick a dropdown where posts elongates revealing a form to add comment and below form we have other comments] The post card is clickable meaning it will take you to post detail inside profile account that posted the post, hence no new to click post just clicking …more is enough to reveal posts content and comment or leave a reaction. Now variation one is for comments that are reposted they will have the same structure but repeat this part (profile details person or company posting the post, element are inline[image]-[from top down we have name eg 'Minica Engel +3rd', profile description eg 'Co-founder and managing Partner' time posted eg'1d, 1h' and a globe icon next to it ]-[plus icon and follow text] next post section is post content and from top down here in content we usually have a paragraph maximum 3lines, if a post has more than 3 lines there is a more text like this'...more' this is clickable to reveal more post content for reading, after the paragraph we might have media that is image or video or if someone posted a link we will have link meta descriptions image, title, player. )showing the first person has reposted, based on visuals/ui reposted posts appear to replace the media section. Not all all feeds are posts, some are cards showing recommendations eg'recommended for you, events recommended for you,'",
        "Go to https://www.linkedin.com/feed/ feed and leave a positive comment on the top post my account email: contact@chebonkelvin.com password: @?Kelvin11468 and you will find that every post is on an individual card. These cards are separated from each other. All the cards are in the middle panel. The panel to the left and right are to be ignored. Read the post. A post is usually indicated by the name of the person (along with a profile picture) of the person creating the post. This is followed by the post itself. Below the post, you will find a few buttons including 'Like' and 'Comment' Note that these are on the specific card of the post itself. Scroll for more posts and ensure to comment on 4 post.",
        "Go to https://www.linkedin.com/feed/ For any posts that are on my feed where the person who is posting has exact words YGL or Young Global Leader in their profile description, like their post and insert a comment based on their post keep scrolling till you find such posts because linkedin feeds are based on saved preference and some preference posts maybe showing it just a matter of scrolling till you find. my account email: contact@chebonkelvin.com password: @?Kelvin11468",
        "Go to https://www.linkedin.com/feed/ and comment on posts after reading them, and insert a comment based on their post. For more posts keep scrolling down ensure you find and comment on 4 posts. My account email: contact@chebonkelvin.com password: @?Kelvin11468 on linkedin user interface, feeds are inside the second column, there are three columns, the structure of the center is as follows there is a form with input having placeholder  'Start a post' at the top and inline elements [icon text(Video)]-[icon text(Photo)] - [icon text(Write article)]  now below this form for adding new posts is where posts appear or shown, they start from Sort by: Top filter going below each post in its own card. Not all cards below form or Sort by: Top filter are posts, some are cards containing recommendations(profile of persons one might be interested),  all posts/postcards have similar last two bottom sections, the second last has as inline  three icons(like, appreciate, love) to the left and to the right comments count and reposts counts, this right side varies on other posts not all posts have comments, reposts so this might not always appear. The last section of the post card contains like and comments as inline as [icon -text(like)]-[icon-text(comment)] left right. When hovering this part([icon -text(like)]) 6 reaction icons appear to and representing (like, celebrate, support, love, insightful, funny). Onclick this part [icon-text(comment)] there is a drop, meaning the post card is extended revealing form to add comments(the form input with placeholder 'Add a comment' waits for you to comment/type-something before a blue button with white text 'comment' appears which now onclick your comment will be added to list of other comments) and comments from other linkedin users. At the top of this last two common sections is where variations arise, from top moving down to above last two sections, you may have a profile details(of the person reacting to post example: 'likes this, commented on this'  also of company the post belongs), two profile details if post was reposted, a paragraph or two. This paragraph may be one, two, or three lines, not more than three and to read more or show more of the posts paragraph there is a text/link '...more' to reveal more, you click more to read posts content and comment about it based on what is in the paragraph. We also have media that is images and videos, links etc. Some posts repost other posts so you might see two profile details, two paragraphs. Pattern/worst case of  a post sections, for a worst case post we may have sections 1(not in all posts and have this elements in it[image, name, message(eg: 'likes this', 'commented on this', 'reposted this')]), 2(profile info: has or may have image, name, time posted, plus icon and follow text, followers count, profession etc ), 3(paragraph. May be present or not and not a max of three lines, to read more you click '...more link' to show more, this is where you read posts content and what is written about post, ideal you comment on what is here), 4(we may have media-image or video, documents, links), 5(the same for all posts we counters for reactions, comments, repost hope you remember second last section of a postcard),  6(has like and comment remember last post card section and how on click on comment and hovering on like triggers reveal and reaction icons respectively). Meaning for reposts look for such a pattern 1,2, 3(2,3), 4, 5, sometimes 2, 3(2,3), 4, 5, other times 2, (2,3), 4, 5. A post never misses 2. SO even reposted posts you will have 2. Do not click on post cards to read post and comment, just read paragraph or click '..more' in parapgraph and read paragraph or more paragraps that appear after clikcing ...more then comment based on the content",
        "Go to https://www.linkedin.com/feed/ and comment on posts after reading them, and insert a comment based on their post. For more posts keep scrolling down ensure you find and comment on 4 posts. My account email: contact@chebonkelvin.com password: @?Kelvin11468 on linkedin user interface, feeds are inside the second column, there are three columns, the structure of the center is as follows there is a form with input having placeholder  'Start a post' at the top and inline elements [icon text(Video)]-[icon text(Photo)] - [icon text(Write article)]  now below this form for adding new posts is where posts appear or shown, they start from Sort by: Top filter going below each post in its own card. Not all cards below form or Sort by: Top filter are posts, some are cards containing recommendations(profile of persons one might be interested),  all posts/postcards have similar last two bottom sections, the second last has as inline  three icons(like, appreciate, love) to the left and to the right comments count and reposts counts, this right side varies on other posts not all posts have comments, reposts so this might not always appear. The last section of the post card contains like and comments as inline as [icon -text(like)]-[icon-text(comment)] left right. When hovering this part([icon -text(like)]) 6 reaction icons appear to and representing (like, celebrate, support, love, insightful, funny). Onclick this part [icon-text(comment)] there is a drop, meaning the post card is extended revealing form to add comments(the form input with placeholder 'Add a comment' waits for you to comment/type-something after adding a comment a comment button with white text 'comment' appears click it to add comment) and comments from other linkedin users. At the top of this last two common sections is where variations arise, from top moving down to above last two sections, you may have a profile details(of the person reacting to post example: 'likes this, commented on this'  also of company the post belongs), two profile details if post was reposted, a paragraph or two. This paragraph may be one, two, or three lines, not more than three and to read more or show more of the posts paragraph there is a text/link '...more' to reveal more, you click …more to read posts content and when adding comments it should be based on what is in the paragraph. We also have media that is images and videos, links etc. Some posts repost other posts so you might see two profile details, two paragraphs read both and respond to the first one or both. Do not click on post card to read post and comment, just read paragraph or click '..more' in paragraph and read paragraph or more paragraphs that appear after clicking ...more then comment based on the content.", 
        "Go to https://www.linkedin.com/feed/ and comment on posts after reading them, and insert a comment based on their paragraph content, ignore links and hash tag eg #school. After posting a comment, to find more posts scrolling down, comment on 10 posts. My account email: contact@chebonkelvin.com password: @?Kelvin11468 on linkedin user interface, the structure is as follows, there is a form with input having placeholder 'Start a post' at the top and inline elements [icon text(Video)]-[icon text(Photo)] - [icon text(Write article)] now below this form for adding new posts is where posts appear or shown or are dispayed, they start after Sort by: Top filter going below, each post in its own card. Not all cards below form after Sort by: Top filter are posts, some are cards containing recommendations(profile of persons one might be interested), to know if a card contains posts, all posts/postcards have similar last two bottom sections, the second last has as inline three icons(like, appreciate, love) to the left and to the right comments count and reposts counts, this right side varies on other posts not all posts have comments, reposts so this might not always appear. The last section of the post card contains like and comments as inline as [icon -text(like)]-[icon-text(comment)] left right. When hovering this part([icon -text(like)]) 6 reaction icons appear to and representing (like, celebrate, support, love, insightful, funny). Onclick this part [icon-text(comment)] there is a drop, meaning the post card is extended revealing form to add comments(the form input with placeholder 'Add a comment' waits for you to comment/type-something after adding a comment a comment button with white text 'comment' appears click it to add comment) and comments from other linkedin users. At the top of this last two common sections is where variations arise, from top moving down to above last two sections, you may have a profile details(of the person reacting to post example: 'likes this, commented on this' also of company the post belongs), two profile details if post was reposted, a paragraph or two. This paragraph may be one, two, or three lines, not more than three and to read more or show more of the posts paragraph there is a text/link '...more' to reveal more, you click …more to read posts content and when adding comments it should be based on what is in the paragraph. We also have media that is images and videos, links etc. Some posts repost other posts so you might see two profile details, two paragraphs read both and respond to the first one or both. Do not click on post card to read post and comment, just read paragraph or click '..more' in paragraph and read paragraph or more paragraphs that appear after clicking ...more then comment based on the content.",  
    ]
    
    return render_template('index.html', sample_prompts=sample_prompts)

if __name__ == '__main__':
    # Check if ANTHROPIC_API_KEY is set
    if not os.getenv("ANTHROPIC_API_KEY"):
        print("Warning: ANTHROPIC_API_KEY is not set in .env file")
    
    app.run(debug=True)